<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Client Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); 
            color: white; 
            padding: 30px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header h1 { 
            font-size: 2rem; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .stats-bar { 
            display: flex; 
            gap: 30px; 
            font-size: 0.9rem; 
        }
        .stat-item { 
            text-align: center; 
        }
        .stat-number { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #4fd1c7; 
        }
        .main-content { 
            padding: 40px; 
        }
        .action-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 12px; 
            border: 2px solid #e9ecef; 
        }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); 
        }
        .btn-success { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); 
            color: white; 
        }
        .clients-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .client-card { 
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 25px; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        }
        .client-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        .client-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 4px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .client-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 20px; 
        }
        .client-info h3 { 
            color: #2d3748; 
            margin-bottom: 5px; 
            font-size: 1.3rem; 
        }
        .client-info p { 
            color: #4a5568; 
            font-size: 0.9rem; 
        }
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 600; 
        }
        .status-active { 
            background: #c6f6d5; 
            color: #22543d; 
        }
        .status-inactive { 
            background: #fed7d7; 
            color: #c53030; 
        }
        .client-details { 
            margin-bottom: 20px; 
        }
        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            padding: 5px 0; 
            border-bottom: 1px solid #e2e8f0; 
        }
        .detail-label { 
            font-weight: 600; 
            color: #4a5568; 
        }
        .detail-value { 
            color: #2d3748; 
            text-align: right; 
            max-width: 60%; 
            word-break: break-word; 
        }
        .client-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .btn-small { 
            padding: 6px 12px; 
            font-size: 0.8rem; 
        }
        .dashboard-url { 
            background: #e6fffa; 
            border: 1px solid #81e6d9; 
            border-radius: 6px; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            font-size: 0.8rem; 
            word-break: break-all; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background-color: white; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .modal-header h2 { 
            color: #2d3748; 
        }
        .close { 
            color: #aaa; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .close:hover { 
            color: #000; 
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #4a5568; 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 1rem; 
            transition: border-color 0.3s; 
        }
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #4a5568; 
        }
        .loading-spinner { 
            border: 4px solid #e2e8f0; 
            border-top: 4px solid #667eea; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .success-message { 
            background: #c6f6d5; 
            color: #22543d; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #9ae6b4; 
        }
        .error-message { 
            background: #fed7d7; 
            color: #c53030; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #feb2b2; 
        }
        @media (max-width: 768px) { 
            .header { 
                flex-direction: column; 
                gap: 20px; 
                text-align: center; 
            }
            .action-bar { 
                flex-direction: column; 
                gap: 15px; 
            }
            .clients-grid { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Admin Dashboard</h1>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="total-clients">0</div>
                    <div>Total Clients</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="active-clients">0</div>
                    <div>Active</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-revenue">$0</div>
                    <div>Monthly Revenue</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="action-bar">
                <h2>Client Management</h2>
                <div>
                    <button class="btn btn-primary" onclick="openCreateClientModal()">
                        ‚ûï Add New Client
                    </button>
                    <button class="btn btn-success" onclick="refreshClients()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Loading clients...</p>
            </div>
            
            <div id="clients-container" style="display: none;">
                <div id="clients-grid" class="clients-grid"></div>
            </div>
        </div>
    </div>

    <!-- Create Client Modal -->
    <div id="createClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Client</h2>
                <span class="close" onclick="closeCreateClientModal()">&times;</span>
            </div>
            <form id="createClientForm">
                <div class="form-group">
                    <label for="business_name">Business Name:</label>
                    <input type="text" id="business_name" name="business_name" required 
                           placeholder="e.g., Emmons Roofing Company">
                </div>
                <div class="form-group">
                    <label for="contact_email">Contact Email:</label>
                    <input type="email" id="contact_email" name="contact_email" required 
                           placeholder="e.g., owner@emmonsroofing.com">
                </div>
                <div class="form-group">
                    <label for="website_url">Website URL:</label>
                    <input type="text" id="website_url" name="website_url" required 
                           placeholder="e.g., emmonsroofing.com">
                </div>
                <div class="form-group">
                    <label for="plan_type">Plan Type:</label>
                    <select id="plan_type" name="plan_type">
                        <option value="basic">Basic ($39/month)</option>
                        <option value="professional">Professional ($99/month)</option>
                        <option value="enterprise">Enterprise ($299/month)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üöÄ Create Client & Generate Secure URL
                </button>
            </form>
        </div>
    </div>

    <script>
        let clients = [];

        // Load clients on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
        });

        async function loadClients() {
            try {
                const response = await fetch('/admin/clients');
                const data = await response.json();
                clients = data.clients;
                displayClients();
                updateStats();
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients');
            }
        }

        function displayClients() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('clients-container');
            const grid = document.getElementById('clients-grid');

            loading.style.display = 'none';
            container.style.display = 'block';

            if (clients.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 40px;">No clients found. Create your first client to get started!</p>';
                return;
            }

            grid.innerHTML = '';
            clients.forEach(client => {
                const clientCard = createClientCard(client);
                grid.appendChild(clientCard);
            });
        }

        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'client-card';

            const dashboardUrl = `${window.location.origin}/dashboard/${client.client_id}`;
            const statusClass = client.subscription_status === 'active' ? 'status-active' : 'status-inactive';
            const planPrice = getPlanPrice(client.plan_type);

            card.innerHTML = `
                <div class="client-header">
                    <div class="client-info">
                        <h3>${client.business_name}</h3>
                        <p>${client.contact_email}</p>
                    </div>
                    <span class="status-badge ${statusClass}">
                        ${client.subscription_status.toUpperCase()}
                    </span>
                </div>
                
                <div class="client-details">
                    <div class="detail-row">
                        <span class="detail-label">Website:</span>
                        <span class="detail-value">${client.website_url}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plan:</span>
                        <span class="detail-value">${client.plan_type} (${planPrice})</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">${formatDate(client.created_at)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Access:</span>
                        <span class="detail-value">${client.last_access ? formatDate(client.last_access) : 'Never'}</span>
                    </div>
                </div>

                <div class="dashboard-url">
                    <strong>üîó Secure Dashboard URL:</strong><br>
                    <span style="color: #2b6cb0;">${dashboardUrl}</span>
                </div>
                
                <div class="client-actions">
                    <button class="btn btn-primary btn-small" onclick="copyDashboardUrl('${dashboardUrl}')">
                        üìã Copy URL
                    </button>
                    <button class="btn btn-success btn-small" onclick="openDashboard('${dashboardUrl}')">
                        üëÅÔ∏è View Dashboard
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deactivateClient('${client.client_id}')">
                        üö´ Deactivate
                    </button>
                </div>
            `;

            return card;
        }

        function updateStats() {
            const totalClients = clients.length;
            const activeClients = clients.filter(c => c.subscription_status === 'active').length;
            const monthlyRevenue = clients
                .filter(c => c.subscription_status === 'active')
                .reduce((total, c) => total + getPlanPriceNumber(c.plan_type), 0);

            document.getElementById('total-clients').textContent = totalClients;
            document.getElementById('active-clients').textContent = activeClients;
            document.getElementById('total-revenue').textContent = `$${monthlyRevenue}`;
        }

        function getPlanPrice(planType) {
            const prices = {
                'basic': '$39/month',
                'professional': '$99/month',
                'enterprise': '$299/month'
            };
            return prices[planType] || '$39/month';
        }

        function getPlanPriceNumber(planType) {
            const prices = {
                'basic': 39,
                'professional': 99,
                'enterprise': 299
            };
            return prices[planType] || 39;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function openCreateClientModal() {
            document.getElementById('createClientModal').style.display = 'block';
        }

        function closeCreateClientModal() {
            document.getElementById('createClientModal').style.display = 'none';
            document.getElementById('createClientForm').reset();
        }

        async function createClient(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const clientData = {
                business_name: formData.get('business_name'),
                contact_email: formData.get('contact_email'),
                website_url: formData.get('website_url'),
                plan_type: formData.get('plan_type')
            };

            try {
                const response = await fetch('/admin/create-client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clientData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`Client created successfully! Dashboard URL: ${result.dashboard_url}`);
                    closeCreateClientModal();
                    loadClients(); // Refresh the client list
                } else {
                    showError(result.error || 'Failed to create client');
                }
            } catch (error) {
                console.error('Error creating client:', error);
                showError('Failed to create client');
            }
        }

        async function deactivateClient(clientId) {
            if (!confirm('Are you sure you want to deactivate this client? They will lose access to their dashboard.')) {
                return;
            }

            try {
                const response = await fetch(`/api/deactivate-client/${clientId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Client deactivated successfully');
                    loadClients(); // Refresh the client list
                } else {
                    showError(result.error || 'Failed to deactivate client');
                }
            } catch (error) {
                console.error('Error deactivating client:', error);
                showError('Failed to deactivate client');
            }
        }

        function copyDashboardUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('Dashboard URL copied to clipboard!');
            }).catch(() => {
                showError('Failed to copy URL');
            });
        }

        function openDashboard(url) {
            window.open(url, '_blank');
        }

        function refreshClients() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('clients-container').style.display = 'none';
            loadClients();
        }

        function showSuccess(message) {
            // Remove existing messages
            const existing = document.querySelector('.success-message, .error-message');
            if (existing) existing.remove();

            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(successDiv, mainContent.firstChild);

            setTimeout(() => successDiv.remove(), 5000);
        }

        function showError(message) {
            // Remove existing messages
            const existing = document.querySelector('.success-message, .error-message');
            if (existing) existing.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(errorDiv, mainContent.firstChild);

            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Attach form submit handler
        document.getElementById('createClientForm').addEventListener('submit', createClient);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createClientModal');
            if (event.target === modal) {
                closeCreateClientModal();
            }
        }
    </script>
</body>
</html>

