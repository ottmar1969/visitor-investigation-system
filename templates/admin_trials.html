<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Management - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); 
            color: white; 
            padding: 30px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header h1 { 
            font-size: 2rem; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .main-content { 
            padding: 40px; 
        }
        .action-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 12px; 
            border: 2px solid #e9ecef; 
        }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); 
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); 
            color: white; 
        }
        .btn-small { 
            padding: 6px 12px; 
            font-size: 0.8rem; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 25px; 
            text-align: center; 
            position: relative; 
            overflow: hidden; 
        }
        .stat-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 4px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .stat-number { 
            font-size: 2.5rem; 
            font-weight: bold; 
            color: #2d3748; 
            margin-bottom: 10px; 
        }
        .stat-label { 
            color: #4a5568; 
            font-size: 1rem; 
        }
        .trials-table { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .table-header { 
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); 
            color: white; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .table-content { 
            overflow-x: auto; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td { 
            padding: 15px; 
            text-align: left; 
            border-bottom: 1px solid #e2e8f0; 
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            color: #4a5568; 
        }
        tr:hover { 
            background: #f8f9fa; 
        }
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 600; 
        }
        .status-active { 
            background: #c6f6d5; 
            color: #22543d; 
        }
        .status-expired { 
            background: #fed7d7; 
            color: #c53030; 
        }
        .status-converted { 
            background: #bee3f8; 
            color: #2c5282; 
        }
        .time-remaining { 
            font-weight: 600; 
        }
        .time-expired { 
            color: #e53e3e; 
        }
        .time-warning { 
            color: #dd6b20; 
        }
        .time-good { 
            color: #38a169; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background-color: white; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .close { 
            color: #aaa; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .close:hover { 
            color: #000; 
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #4a5568; 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 1rem; 
        }
        .duration-presets { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
            margin-top: 10px; 
        }
        .preset-btn { 
            padding: 8px 12px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            border-radius: 6px; 
            cursor: pointer; 
            text-align: center; 
            font-size: 0.9rem; 
            transition: all 0.3s; 
        }
        .preset-btn:hover, .preset-btn.active { 
            border-color: #667eea; 
            background: #667eea; 
            color: white; 
        }
        .success-message { 
            background: #c6f6d5; 
            color: #22543d; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #9ae6b4; 
        }
        .error-message { 
            background: #fed7d7; 
            color: #c53030; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #feb2b2; 
        }
        @media (max-width: 768px) { 
            .header { 
                flex-direction: column; 
                gap: 20px; 
                text-align: center; 
            }
            .action-bar { 
                flex-direction: column; 
                gap: 15px; 
            }
            .stats-grid { 
                grid-template-columns: 1fr; 
            }
            .table-content { 
                font-size: 0.9rem; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïê Trial Management</h1>
            <div>
                <a href="/admin" class="btn btn-primary">‚Üê Admin Dashboard</a>
            </div>
        </div>
        
        <div class="main-content">
            <div class="action-bar">
                <h2>Manage Trial Accounts</h2>
                <button class="btn btn-primary" onclick="openCreateTrialModal()">
                    ‚ûï Create New Trial
                </button>
            </div>
            
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>
            
            <div class="trials-table">
                <div class="table-header">
                    <h3>üìä All Trial Accounts</h3>
                    <button class="btn btn-primary btn-small" onclick="loadTrials()">
                        üîÑ Refresh
                    </button>
                </div>
                <div class="table-content">
                    <table>
                        <thead>
                            <tr>
                                <th>Business</th>
                                <th>Email</th>
                                <th>Duration</th>
                                <th>Time Remaining</th>
                                <th>Status</th>
                                <th>Extensions</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trials-tbody">
                            <!-- Trials will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Trial Modal -->
    <div id="createTrialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Trial</h2>
                <span class="close" onclick="closeCreateTrialModal()">&times;</span>
            </div>
            <form id="createTrialForm">
                <div class="form-group">
                    <label for="business_name">Business Name:</label>
                    <input type="text" id="business_name" name="business_name" required placeholder="e.g., Acme Roofing Company">
                </div>
                
                <div class="form-group">
                    <label for="contact_email">Contact Email:</label>
                    <input type="email" id="contact_email" name="contact_email" required placeholder="e.g., owner@acmeroofing.com">
                </div>
                
                <div class="form-group">
                    <label for="website_url">Website URL:</label>
                    <input type="url" id="website_url" name="website_url" required placeholder="e.g., https://acmeroofing.com">
                </div>
                
                <div class="form-group">
                    <label for="duration_hours">Trial Duration (hours):</label>
                    <input type="number" id="duration_hours" name="duration_hours" min="1" max="8760" value="24" required>
                    
                    <div class="duration-presets">
                        <div class="preset-btn" onclick="setDuration(3)">3 Hours</div>
                        <div class="preset-btn" onclick="setDuration(24)">1 Day</div>
                        <div class="preset-btn" onclick="setDuration(72)">3 Days</div>
                        <div class="preset-btn" onclick="setDuration(120)">5 Days</div>
                        <div class="preset-btn" onclick="setDuration(168)">1 Week</div>
                        <div class="preset-btn" onclick="setDuration(720)">30 Days</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="trial_type">Trial Type:</label>
                    <select id="trial_type" name="trial_type">
                        <option value="standard">Standard Trial</option>
                        <option value="demo">Demo Trial</option>
                        <option value="extended">Extended Trial</option>
                        <option value="vip">VIP Trial</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üöÄ Create Trial Account
                </button>
            </form>
        </div>
    </div>

    <!-- Extend Trial Modal -->
    <div id="extendTrialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Extend Trial</h2>
                <span class="close" onclick="closeExtendTrialModal()">&times;</span>
            </div>
            <form id="extendTrialForm">
                <input type="hidden" id="extend_client_id" name="client_id">
                
                <div class="form-group">
                    <label for="additional_hours">Additional Hours:</label>
                    <input type="number" id="additional_hours" name="additional_hours" min="1" max="8760" value="24" required>
                    
                    <div class="duration-presets">
                        <div class="preset-btn" onclick="setExtensionDuration(24)">1 Day</div>
                        <div class="preset-btn" onclick="setExtensionDuration(72)">3 Days</div>
                        <div class="preset-btn" onclick="setExtensionDuration(168)">1 Week</div>
                        <div class="preset-btn" onclick="setExtensionDuration(720)">30 Days</div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-warning" style="width: 100%;">
                    ‚è∞ Extend Trial
                </button>
            </form>
        </div>
    </div>

    <script>
        let trials = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTrials();
        });

        async function loadTrials() {
            try {
                const response = await fetch('/api/trials');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                trials = data.trials;
                displayTrials();
                updateStats();
                
            } catch (error) {
                console.error('Error loading trials:', error);
                showError('Failed to load trials');
            }
        }

        function displayTrials() {
            const tbody = document.getElementById('trials-tbody');
            
            if (trials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #4a5568; padding: 40px;">No trial accounts found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            trials.forEach(trial => {
                const row = createTrialRow(trial);
                tbody.appendChild(row);
            });
        }

        function createTrialRow(trial) {
            const row = document.createElement('tr');

            const statusClass = trial.status === 'active' ? 'status-active' : 
                               trial.status === 'converted' ? 'status-converted' : 'status-expired';

            let timeRemainingText = 'Expired';
            let timeClass = 'time-expired';
            
            if (trial.time_remaining_hours !== null && trial.time_remaining_hours > 0) {
                if (trial.time_remaining_hours < 24) {
                    timeRemainingText = `${trial.time_remaining_hours}h`;
                    timeClass = trial.time_remaining_hours < 6 ? 'time-warning' : 'time-good';
                } else {
                    const days = Math.floor(trial.time_remaining_hours / 24);
                    const hours = trial.time_remaining_hours % 24;
                    timeRemainingText = `${days}d ${hours}h`;
                    timeClass = 'time-good';
                }
            }

            row.innerHTML = `
                <td>
                    <strong>${trial.business_name}</strong><br>
                    <small style="color: #4a5568;">${trial.website_url}</small>
                </td>
                <td>${trial.contact_email}</td>
                <td>${trial.trial_duration_hours}h</td>
                <td>
                    <span class="time-remaining ${timeClass}">${timeRemainingText}</span>
                </td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${trial.status.toUpperCase()}
                    </span>
                </td>
                <td>${trial.extension_count || 0}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${trial.status === 'active' && !trial.is_expired ? `
                            <button class="btn btn-warning btn-small" onclick="openExtendTrialModal('${trial.client_id}')">
                                ‚è∞ Extend
                            </button>
                            <button class="btn btn-success btn-small" onclick="convertTrial('${trial.client_id}')">
                                üí∞ Convert
                            </button>
                            <button class="btn btn-danger btn-small" onclick="restrictTrial('${trial.client_id}')">
                                üö´ Restrict
                            </button>
                        ` : trial.status === 'expired' ? `
                            <button class="btn btn-warning btn-small" onclick="openExtendTrialModal('${trial.client_id}')">
                                üîÑ Reactivate
                            </button>
                            <button class="btn btn-success btn-small" onclick="convertTrial('${trial.client_id}')">
                                üí∞ Convert
                            </button>
                        ` : `
                            <span style="color: #4a5568; font-size: 0.8rem;">Converted</span>
                        `}
                    </div>
                </td>
            `;

            return row;
        }

        function updateStats() {
            const activeTrials = trials.filter(t => t.status === 'active' && !t.is_expired).length;
            const expiredTrials = trials.filter(t => t.is_expired || t.status === 'expired').length;
            const convertedTrials = trials.filter(t => t.status === 'converted').length;
            const expiringToday = trials.filter(t => t.time_remaining_hours !== null && t.time_remaining_hours <= 24 && t.time_remaining_hours > 0).length;

            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number" style="color: #38a169;">${activeTrials}</div>
                    <div class="stat-label">Active Trials</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #dd6b20;">${expiringToday}</div>
                    <div class="stat-label">Expiring Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #e53e3e;">${expiredTrials}</div>
                    <div class="stat-label">Expired Trials</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #3182ce;">${convertedTrials}</div>
                    <div class="stat-label">Converted</div>
                </div>
            `;
        }

        function openCreateTrialModal() {
            document.getElementById('createTrialModal').style.display = 'block';
        }

        function closeCreateTrialModal() {
            document.getElementById('createTrialModal').style.display = 'none';
            document.getElementById('createTrialForm').reset();
        }

        function openExtendTrialModal(clientId) {
            document.getElementById('extend_client_id').value = clientId;
            document.getElementById('extendTrialModal').style.display = 'block';
        }

        function closeExtendTrialModal() {
            document.getElementById('extendTrialModal').style.display = 'none';
            document.getElementById('extendTrialForm').reset();
        }

        function setDuration(hours) {
            document.getElementById('duration_hours').value = hours;
            
            // Update active state
            document.querySelectorAll('.duration-presets .preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setExtensionDuration(hours) {
            document.getElementById('additional_hours').value = hours;
            
            // Update active state
            document.querySelectorAll('#extendTrialModal .duration-presets .preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function createTrial(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const trialData = {
                business_name: formData.get('business_name'),
                contact_email: formData.get('contact_email'),
                website_url: formData.get('website_url'),
                duration_hours: parseInt(formData.get('duration_hours')),
                trial_type: formData.get('trial_type'),
                granted_by: 'admin'
            };

            try {
                const response = await fetch('/api/create-trial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(trialData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`Trial created successfully! Dashboard URL: ${result.dashboard_url}`);
                    closeCreateTrialModal();
                    loadTrials();
                } else {
                    showError(result.error || 'Failed to create trial');
                }
            } catch (error) {
                console.error('Error creating trial:', error);
                showError('Failed to create trial');
            }
        }

        async function extendTrial(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const clientId = formData.get('client_id');
            const additionalHours = parseInt(formData.get('additional_hours'));

            try {
                const response = await fetch(`/api/extend-trial/${clientId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        additional_hours: additionalHours,
                        extended_by: 'admin'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`Trial extended successfully by ${additionalHours} hours!`);
                    closeExtendTrialModal();
                    loadTrials();
                } else {
                    showError(result.error || 'Failed to extend trial');
                }
            } catch (error) {
                console.error('Error extending trial:', error);
                showError('Failed to extend trial');
            }
        }

        async function convertTrial(clientId) {
            if (!confirm('Convert this trial to a full paid account?')) {
                return;
            }

            try {
                const response = await fetch(`/api/convert-trial/${clientId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan_type: 'basic'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Trial converted to full account successfully!');
                    loadTrials();
                } else {
                    showError(result.error || 'Failed to convert trial');
                }
            } catch (error) {
                console.error('Error converting trial:', error);
                showError('Failed to convert trial');
            }
        }

        async function restrictTrial(clientId) {
            if (!confirm('Manually restrict this trial account? This will immediately block access.')) {
                return;
            }

            try {
                const response = await fetch(`/api/restrict-trial/${clientId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Trial access restricted successfully!');
                    loadTrials();
                } else {
                    showError(result.error || 'Failed to restrict trial');
                }
            } catch (error) {
                console.error('Error restricting trial:', error);
                showError('Failed to restrict trial');
            }
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(notification, mainContent.firstChild);

            setTimeout(() => notification.remove(), 5000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'error-message';
            notification.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(notification, mainContent.firstChild);

            setTimeout(() => notification.remove(), 5000);
        }

        // Attach form submit handlers
        document.getElementById('createTrialForm').addEventListener('submit', createTrial);
        document.getElementById('extendTrialForm').addEventListener('submit', extendTrial);

        // Close modals when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createTrialModal');
            const extendModal = document.getElementById('extendTrialModal');
            
            if (event.target === createModal) {
                closeCreateTrialModal();
            }
            if (event.target === extendModal) {
                closeExtendTrialModal();
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(loadTrials, 300000);
    </script>
</body>
</html>

